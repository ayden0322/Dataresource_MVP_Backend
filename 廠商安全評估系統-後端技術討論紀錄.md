# 廠商安全評估資料蒐集系統 - 後端技術討論紀錄

## 一、專案目標

建立一個能讓管理者設定專案、供廠商上傳所需文件、並進行審核與追蹤進度的系統。後端負責：

* 管理者與權限管理
* 專案建立與文件清單設定
* 檔案上傳、掃毒、安全儲存
* 文件版本管理與審核流程
* 審核通知（Email / LINE Notify）
* 稽核與追蹤機制

---

## 二、主要角色與權限

* **總管理者 (Super Admin)**：建立初始帳號、管理其他管理者、設定角色權限。
* **管理者 (Admin)**：根據授權建立專案、審核文件、檢視進度。
* **上傳方 (Vendor)**：透過專案連結上傳檔案、查看狀態、補件。

---

## 三、系統架構與模組

### 主要資料表

| 資料表                   | 用途                  |
| --------------------- | ------------------- |
| users                 | 管理者帳號資料             |
| roles / permissions   | 角色與權限設定             |
| projects              | 工程專案基本資料            |
| document_templates    | 文件清單模板（來源：安全評估審查資料） |
| project_required_docs | 專案中勾選的上傳項目          |
| uploads               | 每次上傳紀錄（含版本）         |
| reviews               | 審核紀錄（綁定上傳版本）        |
| audit_logs            | 稽核操作軌跡              |
| review_locks          | 審核鎖，避免同時修改衝突        |
| project_links         | 專案外部上傳連結管理          |

---

## 四、檔案上傳與病毒掃描流程

### 結論

新檔案先進入「隔離區」(Quarantine)，經掃毒通過後才搬到「安全區」(Safe)。

### 流程說明

1. **預簽名上傳 URL**：後端產生一次性上傳連結（讓使用者直接傳至雲端）。
2. **隔離區**：上傳檔案先進 quarantine 資料夾。
3. **掃毒機器人 (Worker)**：自動使用 ClamAV（防毒軟體）掃描檔案。
4. **安全區**：掃毒通過後，移動到 safe 資料夾；失敗則標記 INFECTED。

### 例子

廠商上傳「施工計畫.pdf」→ 進隔離區 → 掃毒通過 → 搬到安全區 → 可預覽。

**優點**：先隔離再放行，確保後台安全、可擴充。

---

## 五、版本管理與審核

### 結論

每次上傳都生成一個獨立版本 (v1, v2, v3)，審核記錄綁定版本，確保可追溯。

### 實例

* 廠商 10:00 上傳 v1；10:05 上傳 v2。
* 管理者可選擇審 v2 或退回 v1，不會出現版本混亂。

**用途**：稽核追蹤、法律依據、差異比對。

---

## 六、通知機制 (Email / LINE Notify)

### Email

* 使用 AWS SES 或 SendGrid 寄信。
* 系統事件（如審核通過/退回）觸發通知服務寄送信件。

### LINE Notify

* 使用者先授權取得 LINE Token。
* 後端根據事件呼叫 LINE API 推送通知。

### 例子

管理者通過「施工計畫」→ 系統寄出 Email & LINE 訊息：

> 您的施工計畫已通過 ✅。

---

## 七、安全與技術選擇

| 項目   | 採用方案                       | 說明             |
| ---- | -------------------------- | -------------- |
| 檔案儲存 | AWS S3 / MinIO             | 支援版本化與加密       |
| 掃毒   | ClamAV Worker              | 自動掃描上傳檔案       |
| 上傳   | 預簽名 URL + 分段直傳 (Multipart) | 大檔案上傳穩定、可續傳    |
| 權限控制 | RBAC 模式                    | 角色+權限表組合       |
| 資料庫  | PostgreSQL                 | 支援 JSON 欄位與交易鎖 |
| 快取/鎖 | Redis                      | 審核鎖、進度快取       |
| 後端框架 | NestJS / FastAPI           | 模組化、易維護        |

---

## 八、分段直傳 (Multipart Upload)

### 結論

將大檔切成小塊上傳，失敗只需重傳該小塊，提高成功率。

### 例子

上傳 600MB DWG 時，分成 10MB/片。若傳到一半斷線，只要重傳後半段即可。

**優點**：穩定、省時、省流量。

---

## 九、審核衝突處理機制

### 結論

管理者送審時，後端檢查版本；若使用者已上傳新版本，回覆 409 Conflict，提醒刷新最新檔案。

### 例子

管理者審 v1 時，廠商剛傳 v2 → 系統提示「有新版本，是否切換？」

**好處**：避免通過錯版檔案，同時不阻擋廠商上傳。

---

## 十、多檔上傳 (PDF + CAD)

### 結論

一個項目可包含多個子檔需求（例：PDF 與 CAD），各自上傳與審核，全部通過才算完成。

### 例子

* 施工圖說：需上傳 PDF 與 DWG 各一份。
* PDF 審核通過、DWG 退回 → 顯示「需補件」。

**好處**：明確控管每個檔案狀態、避免混亂。

---

## 十一、名詞說明（白話版）

| 名詞           | 說明                       |
| ------------ | ------------------------ |
| 預簽名上傳 URL    | 一次性上傳入口票，讓使用者直接傳檔至雲端。    |
| S3 / MinIO   | 雲端檔案倉庫（像硬碟伺服器）。          |
| 隔離區 / 安全區    | 新檔先關起來掃毒（隔離），沒問題再開放（安全）。 |
| Worker       | 背景小幫手，專做掃毒、轉檔等工作。        |
| ClamAV       | 免費開源防毒引擎。                |
| 事件 (Event)   | 系統的通知訊號，讓其他模組知道發生什麼事。    |
| 409 Conflict | 代表你操作的資料已被更新，需要先刷新再提交。   |

---

## 十二、後續開發方向

1. 建立資料表 Schema（PostgreSQL）
2. 撰寫 API 規格書（OpenAPI 3）
3. 實作檔案上傳/掃毒流程
4. 審核流程 + 通知整合
5. 稽核與報表模組

---

## 十三、細節補強與設計決策（v1）

> 針對風險與遺漏處做具體補齊，作為後續 API 與 Schema 的設計依據。

### 13.1 安全性強化

**預簽名上傳 URL（Presigned URL）**

* 有效期限：**5–15 分鐘**（預設 10 分鐘），逾時需重新索取。
* 檔名/路徑：**由後端產生 UUID key**（禁止客戶端帶路徑），避免 Path Traversal。
* 大小限制：依「子檔需求」設定（例：PDF ≤100MB、DWG ≤500MB），超過即拒絕簽名。
* 檔案類型白名單：副檔名 + MIME 兩層驗證（.pdf/.docx/.dwg/.dxf…）。
* 雜湊上傳：前端計算 **SHA-256** 隨請求送出，比對後才接受完成。

**隔離區/安全區**

* 物件儲存：兩個獨立 Bucket/Prefix：`quarantine/`（不可讀）、`safe/`（僅短效簽名可讀）。
* 加密：SSE-KMS（伺服器端加密，金鑰以 KMS 管理）。
* 存取：僅掃毒 Worker 與後端服務角色可存取 `quarantine/`；**無公開權限**。
* 自動清理：`quarantine/` 設 **7 天** Lifecycle 規則自動刪除。

**掃毒（ClamAV）**

* 病毒庫：**每日自動更新**（freshclam 定時），失敗警報。
* 超時：單檔掃描 **上限 5 分鐘**；逾時標記 `SCAN_TIMEOUT`，重試最多 2 次。
* 多引擎（選配）：可併用第二層商用掃毒引擎或**沙箱執行**（以容器 seccomp/AppArmor + ReadOnlyFS）。
* 結果：寫入 `uploads.scan_status`（CLEAN/INFECTED/TIMEOUT）與 `scan_sig`（病毒碼/原因）。

**零日風險緩解**

* 嚴格白名單 + 檔案轉換預覽（docx→pdf）降低主機端攻擊面。
* 後台預覽以 **短效簽名 URL** + 只讀 iframe/Viewer，禁止下載至使用者端（視權限）。

### 13.2 資料設計補強

**關聯與欄位**

* `document_templates(id, name, category, ... )`
* `template_items(id, template_id, code, name, required, allowed_exts, max_size_mb, multi)`
* `projects(id, ...)`
* `project_required_docs(id, project_id, template_item_id, required, note, status, row_version)`
* `required_doc_assets(id, required_doc_id, code, name, allowed_exts, max_size_mb, required)` ← 子檔需求（如 PDF/CAD）
* `uploads(id, asset_id, version_no, storage_key, original_name, size_bytes, mime, sha256, scan_status, created_by, created_at)`
* `reviews(id, upload_id, decision(APPROVE/REJECT), comment, reviewer_id, created_at)`
* `notifications(id, channel, to_ref, template_key, payload_json, status, retry_count, created_at)`
* `file_checksums(sha256 unique, first_upload_id, last_seen_at, count)`
* `audit_logs(id, actor_id, action, target_type, target_id, ip, user_agent, detail_json, created_at, hash_chain)`

**索引策略**

* 常用查詢欄位建立索引：`project_required_docs(project_id,status)`、`uploads(asset_id,created_at)`、`reviews(upload_id)`、`audit_logs(created_at)`。
* 大列表提供 **分頁**：`created_at` + `id` 遞減（游標分頁優先）。

### 13.3 併發與鎖定

* **鎖粒度**：以 **文件子資產（asset）** 為最小單位（避免整專案被鎖）。
* **樂觀鎖**：`project_required_docs.row_version` 送審時必帶；不一致回 **409**。
* **Redis 軟鎖（可選）**：`review:lock:{assetId}`，TTL **10 分鐘**，續租心跳；逾時自釋放。
* **交易鎖**：關鍵更新使用 SQL `SELECT ... FOR UPDATE`（避免同時產生版本號）。

### 13.4 版本管理策略

* 版本號：**系統自動遞增**，以 `(asset_id, version_no)` 唯一索引保障。
* 同時上傳：以交易鎖/序列保證版本連續，不產生衝突。
* 保留策略：預設保留 **最近 10 版**；更舊版本轉入歸檔層（冷存/低頻存取）或清理（可設定）。
* 邏輯狀態：文件目前狀態以「**最新已審核版本**」決定；若有未審核新版本 → 顯示「審核中」。

### 13.5 通知強化

* LINE Token：以 KMS **加密儲存**，定期驗證；401/403 視為過期→標記需重綁並寄 Email 通知。
* 重試：Email/LINE 失敗 **指數退避**（1m/5m/15m），最多 5 次；超限進 **DLQ** 專區。
* 頻率限制：同一收件人同專案 **每 10 分鐘最多 1 封**（可調），避免限流。
* 模板管理：`notification_templates`（key、locale、subject、body），支援參數化與多語系。
* 退信/退訂：接收供應商 **取消訂閱**（僅保留系統必要通知）。

### 13.6 稽核與合規

* 紀錄動作：登入/登出、建立/修改/刪除專案、上傳、審核、權限變更、連結產生/停用、通知寄送結果。
* 內容：時間、actor、目標（型別/ID）、IP、User-Agent、前後差異（diff）。
* 保存期限：**7 年**（可調）；每月生成 **Merkle Root/Hash Chain**，存放於不可變儲存（Object Lock/WORM），確保不可竄改性。

### 13.7 效能與可擴展

* 任務佇列：**AWS SQS**（或 RabbitMQ）。
* Worker 自動伸縮：以佇列深度與處理時間決定 **min/max 數量**（例如 2–10）。
* 重試：掃毒/轉檔失敗自動重試 2–3 次；超過進 DLQ 警報。
* 佇列優先序：掃毒 > 轉檔 > 產縮圖；避免阻塞主要流程。

### 13.8 分段直傳細節

* 分段大小：預設 **8MB**（可動態）；最小 5MB（S3 限制）。
* 續傳：保存 `uploadId` 與已完成 parts 清單；中斷後從缺漏的 part 繼續。
* 完成期限：**24 小時** 內完成合併；逾時作廢。
* 自動清理：設定儲存層的 **AbortIncompleteMultipartUpload=7 天**。

### 13.9 權限模型（RBAC 擴充）

* 結構：`users → user_roles → roles → role_permissions → permissions`。
* 專案成員：`project_members(user_id, project_id, role)` 支援專案級授權。
* 粒度：功能（project:create, review:approve…）＋ 範圍（全域/專案/文件）。
* 臨時授權：支援 **到期日**（外部稽核人員）與只讀權限。

### 13.10 容錯與備援

* 物件儲存：跨區複寫/版本化；Bucket Policy 最小權限。
* DB：PostgreSQL 主從複製（熱備），定期快照；重大更新使用交易與回滾點。
* Redis：故障時降級到純樂觀鎖；恢復後自動重建快取。
* 掃毒服務：多副本 + 健康檢查；全掛時 **禁止檔案進入安全區**。

### 13.11 API 治理原則

* 認證：短存活 **JWT** + Refresh，管理端可接 **OIDC**。
* Rate Limit：依 IP 與使用者雙維度（例：`/public` 60 req/min、`/admin` 120 req/min）。
* CORS：明確 allowlist（前端網域）；禁止 `*`。
* 版本：URL 前綴 **/api/v1**；重大變更升版本。

### 13.12 測試與監控

* 測試：單元（業務邏輯、掃毒介面 mock）、整合（上傳→掃毒→審核→通知）、E2E（前後串測）。
* 效能基準：**同時 100 人上傳**、平均掃毒時間、95% 延遲；設定 SLO。
* 監控：APM（延遲、錯誤率）、佇列深度、掃毒成功率、儲存用量、DB/Redis 健康。
* 告警：掃毒失敗率 >5%、儲存使用率 >80%、隊列積壓 >10 分鐘、HTTP 5xx 突增。

---

## 十四、文件狀態機（Detail v1）

> 規範「主項目」與「子資產（PDF、CAD…）」的狀態、轉移條件與邊界行為。

### 14.1 子資產（asset）狀態

| 狀態             | 說明       | 觸發條件          | 備註              |
| -------------- | -------- | ------------- | --------------- |
| NOT_UPLOADED   | 尚未有任何版本  | 預設            | 顯示上傳按鈕          |
| QUARANTINE     | 已上傳，待掃毒  | 完成直傳+callback | 不可預覽，不可下載       |
| SCAN_TIMEOUT   | 掃毒逾時     | 掃毒超過 5 分鐘     | 將自動重試 2 次       |
| INFECTED       | 掃毒判為惡意   | ClamAV 回傳病毒碼  | 通知上傳方重傳；此版本不進審核 |
| PENDING_REVIEW | 掃毒通過，待審核 | CLEAN 後       | 管理端開放預覽與審核      |
| APPROVED       | 已通過審核    | 審核決議=通過       | 前端停用上傳按鈕        |
| REJECTED       | 審核退回     | 審核決議=退回       | 前端狀態顯示需補件，開啟上傳  |

**邊界**：若在 `PENDING_REVIEW`/`APPROVED` 之後又有新版本上傳，整體「顯示狀態」回到 `PENDING_REVIEW`（以最新未審核版本為準），直到最新版本審完。

### 14.2 主項目（required_doc）狀態

* 衍生自所有 **必填子資產** 的最小狀態：

  * 任何子資產 `INFECTED` → 主項目顯示 **需重傳**。
  * 所有必填子資產均 `APPROVED` → 主項目 **完成**；否則依最嚴格狀態（例如有一個 `PENDING_REVIEW` 就顯示「審核中」）。

### 14.3 版本與審核衝突處理（強化）

* 送審需帶 `target_upload_version` 與 `row_version`；若和最新版本不符 → 回 409，前端彈窗提示是否切至最新版。
* 可選「force=true」允許通過舊版（須具特權/設定開啟），審批紀錄綁定舊版。

---

## 十五、檔案生命週期與儲存分層

| 階段         | 儲存位置          | 加密      | 存留       | 清理規則                          |
| ---------- | ------------- | ------- | -------- | ----------------------------- |
| 上傳完成待掃毒    | `quarantine/` | SSE-KMS | 最多 7 天   | Lifecycle 自動刪除（含逾時 multipart） |
| 掃毒通過       | `safe/`       | SSE-KMS | 永久/依專案保留 | 專案結束 X 天後轉冷存（Glacier/低頻）      |
| 歸檔（超過版本上限） | `archive/`    | SSE-KMS | 依保留政策    | 僅管理端可復原                       |
| 受感染/逾時     | `quarantine/` | SSE-KMS | 7 天      | 自動刪除並保留紀錄（無檔案內容）              |

**保留策略建議**：保留最近 **10 版**於 `safe/`；更舊版本移至 `archive/`。專案結束後 **180 天** 移冷存，**7 年** 期滿再評估清理。

---

## 十六、通知規格細化（Email / LINE）

### 16.1 範本（Templates）

* `review_approved`：主旨「【{project}】{doc_name} 已通過」
* `review_rejected`：主旨「【{project}】{doc_name} 需補件」
* `scan_infected`：主旨「【{project}】{doc_name} 檔案含風險」
* 變數：`{project}`, `{doc_name}`, `{link}`, `{reason}`, `{deadline}`

### 16.2 頻率與重試

* 頻率：同一收件人同專案 **10 分鐘 1 則** 上限。
* 重試：1m → 5m → 15m → 60m（最多 5 次），失敗後進 DLQ，觸發告警。

### 16.3 退信/退訂

* 退信（bounce）Webhook 回填 `notifications.status=bounced`，並以 Email 提醒改用其他聯絡管道。
* 退訂：供應商可關閉行銷型通知；系統級（審核/安全）通知不可關閉。

---

## 十七、錯誤碼與回應原則（摘要）

| 代碼  | 場景           | 回應內容                                       |
| --- | ------------ | ------------------------------------------ |
| 400 | 檔案型態不允許/超過大小 | `code=INVALID_FILE_TYPE/SIZE` + allowed 列表 |
| 401 | 未授權/Token 失效 | `code=UNAUTHORIZED`                        |
| 403 | 無權限（角色或專案範圍） | `code=FORBIDDEN`                           |
| 404 | 對象不存在        | `code=NOT_FOUND`                           |
| 409 | 版本/狀態衝突      | `code=VERSION_CONFLICT` + `latestVersion`  |
| 422 | 業務規則未滿足      | `code=UNPROCESSABLE` + details             |
| 429 | 超過速率限制       | `code=RATE_LIMITED` + retryAfter           |
| 500 | 伺服器錯誤        | `code=INTERNAL_ERROR`                      |

**一致性**：所有錯誤以 `{ code, message, details, traceId }` 回傳；`traceId` 方便追蹤。

---

## 十八、上傳前端行為與限制清單

* 單檔大小上限與副檔名白名單由後端提供配置 API；前端套用以避免無謂上傳。
* 上傳前計算 **SHA-256**，成功後與伺服器比對（避免重傳同檔）。
* 使用 **multipart upload**：分段大小預設 8MB、最多並行 6 線；支援續傳。
* 完成後必呼叫 `complete`，否則不觸發掃毒。
* 審核期間可重傳；若管理端送審遇 409，自動提示同步最新版。

---

## 十九、管理端審核作業 SOP（v1）

1. 打開專案 → 進入文件清單 → 選取子資產（PDF/CAD）。
2. 若狀態 `PENDING_REVIEW`，載入「該版本」預覽（Docx→PDF 已轉）。
3. 點擊「通過/退回」，輸入備註（退回需填理由）。
4. 送出時攜帶 `target_upload_version` 與 `row_version`。
5. 若回 409 → 選擇「切換至最新版」或「仍以舊版決議」（需權限）。
6. 成功後觸發通知；列表即時更新進度與百分比。

---

## 二十、監控指標與告警（SLO v1）

| 指標       | 目標        | 告警條件                |
| -------- | --------- | ------------------- |
| 掃毒成功率    | ≥ 99.5%   | 5 分鐘平均 < 98% 連續 3 次 |
| 掃毒平均延遲   | p95 ≤ 30s | p95 > 60s 連續 3 次    |
| 上傳成功率    | ≥ 99.0%   | 小時平均 < 97%          |
| 佇列深度（掃毒） | p95 ≤ 100 | > 500 且持續 10 分鐘     |
| 儲存使用率    | < 80%     | > 85% 觸發預警          |
| 5xx 比率   | < 0.5%    | > 1% （5 分鐘）         |

**告警管道**：Email / LINE Notify / PagerDuty（可選）。
